// Prisma schema for MealPlan

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  // URL configured in prisma.config.ts
}

// Single meal plan (no users, single-user app)
model MealPlan {
  id            String    @id @default("singleton")
  startDate     String?   // ISO date (YYYY-MM-DD)
  currentDay    String?   // ISO date (YYYY-MM-DD)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // TRMNL sync tracking
  lastPushHash  String?   // SHA-256 hash for change detection
  lastPushAt    DateTime? // Timestamp of last successful push
  lastPushError String?   // Last error message if push failed

  // Global app settings
  sortingPrompt String?   // Custom AI sorting prompt for shopping list (null = use default)

  days          DayPlan[]
}

model DayPlan {
  id         String   @id @default(cuid())
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  date       String   // ISO date (YYYY-MM-DD)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  meals      Meal[]

  @@unique([mealPlanId, date])
  @@index([mealPlanId])
}

model Meal {
  id        String   @id @default(cuid())
  dayPlanId String
  dayPlan   DayPlan  @relation(fields: [dayPlanId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dayPlanId])
}

// Archived meal plans for history
model ArchivedMealPlan {
  id        String   @id @default(cuid())
  startDate String   // ISO date (YYYY-MM-DD)
  endDate   String   // ISO date (YYYY-MM-DD)
  data      String   // JSON snapshot of days and meals
  createdAt DateTime @default(now())
}

// Shopping list (singleton pattern like MealPlan)
model ShoppingList {
  id        String             @id @default("singleton")
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  items     ShoppingListItem[]
}

model ShoppingListItem {
  id             String       @id @default(cuid())
  shoppingListId String
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  name           String
  checked        Boolean      @default(false)
  sortOrder      Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([shoppingListId])
}

// Archived shopping lists for history
model ArchivedShoppingList {
  id        String   @id @default(cuid())
  data      String   // JSON snapshot of items
  createdAt DateTime @default(now()) // Timestamp of when original list was created
}
